___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "AFFILIATE_MARKETING",
    "ADVERTISING"
  ],
  "displayName": "Kwanko",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Addingwell",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "Tag to implement server-side cookie for Kwanko and setup concurrent tracking with server to server (S2S).",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "customerId",
    "displayName": "Kwanko Id",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Your unique identifier on Kwanko",
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "clearCookie",
    "checkboxText": "Clear Kwanko cookie when receiving a purchase",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "standardParameters",
    "displayName": "Overwrite Standard Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "label1",
        "displayName": "By default, it uses GA4 ecommerce fields"
      },
      {
        "type": "TEXT",
        "name": "transactionId",
        "displayName": "Unique transaction reference",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "purchaseAmount",
        "displayName": "Purchase amount",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "currency",
        "displayName": "Currency",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "coupon",
        "displayName": "Coupon used",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "payName",
        "displayName": "Method of payment used",
        "simpleValueType": true,
        "help": "Clear name, without space, special characters or accent. For example: \"paypal\", or \"moneytransfer\"."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedParameters",
    "displayName": "Advanced Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "pageViewEvent",
        "displayName": "Page view event name",
        "simpleValueType": true,
        "defaultValue": "page_view"
      },
      {
        "type": "TEXT",
        "name": "purchaseEvent",
        "displayName": "Purchase event name",
        "simpleValueType": true,
        "defaultValue": "purchase"
      },
      {
        "type": "TEXT",
        "name": "leadEvent",
        "displayName": "Lead event name",
        "simpleValueType": true,
        "defaultValue": "generate_lead"
      },
      {
        "type": "TEXT",
        "name": "cookieExpiration",
        "displayName": "Cookie expiration in days",
        "simpleValueType": true,
        "defaultValue": 30,
        "valueValidators": [
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const parseUrl = require('parseUrl');
const encodeUriComponent = require('encodeUriComponent');

const eventModel = getAllEventData();

const PAGE_VIEW_EVENT = data.pageViewEvent;
const PURCHASE_EVENT = data.purchaseEvent;
const GENERATE_LEAD_EVENT = data.leadEvent;


function safeEncodeUriComponent(value) {
  value = value || '';
  return encodeUriComponent(value);
}

switch (eventModel.event_name) {
  case PAGE_VIEW_EVENT:
    const parsedUrl = parseUrl(eventModel.page_location);
    const params = {};

    if (parsedUrl && parsedUrl.searchParams) {
      for (let param in parsedUrl.searchParams) {
        if (param.toLowerCase() === 'kwks2s') {
          params.kwks2s = parsedUrl.searchParams[param];
          break;
        }
      }
    }

    if (params.kwks2s) {
      const value = params.kwks2s;

      const options = {
        domain: 'auto',
        path: '/',
        secure: true,
        httpOnly: false,
        'max-age': 86400 * data.cookieExpiration
      };
      setCookie('kwk', value, options, false);
    }

    data.gtmOnSuccess();
    break;
  case PURCHASE_EVENT:
  case GENERATE_LEAD_EVENT:
    const kwankoCookie = getCookieValues('kwk');

    if (!kwankoCookie || !kwankoCookie[0]) {
      data.gtmOnSuccess();
      break; 
    }

    const urlParams = [
      'mclic=' + safeEncodeUriComponent(data.customerId),

      'cible=' + safeEncodeUriComponent(kwankoCookie[0]),
      'argann=' + safeEncodeUriComponent(data.transactionId ? data.transactionId : eventModel.transaction_id)
    ];
    
    if (eventModel.event_name === PURCHASE_EVENT) {
      urlParams.push('argmon=' + safeEncodeUriComponent(data.purchaseAmount ? data.purchaseAmount : eventModel.value));

      urlParams.push(
        data.currency !== undefined || eventModel.currency !== undefined ?
          'nacur=' + safeEncodeUriComponent(data.currency ? data.currency : eventModel.currency) :
          ''
      );
      urlParams.push(
        data.coupon !== undefined || eventModel.coupon !== undefined ?
          'argbr=' + safeEncodeUriComponent(data.voucher ? data.coupon : eventModel.coupon) :
          ''
      );

      urlParams.push(data.payName !== undefined ? 'argmodp=' + safeEncodeUriComponent(data.payName) : '');
    }

    const urlParamsString = urlParams.filter((v) => v).join('&');

    if (data.clearCookie) {
      setCookie('kwk', '', {
        domain: 'auto',
        path: '/',
        secure: true,
        httpOnly: false,
        'max-age': 10
      }, false);
    }

    const requestHeaders = { method: 'GET' };
    const url = 'https://action.metaffiliation.com/trk.php?' + urlParamsString;
    sendHttpRequest(url, (statusCode, headers, body) => {
      if (statusCode >= 200 && statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    }, requestHeaders, '');
    break;
  default:
    data.gtmOnSuccess();
    break;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://action.metaffiliation.com/trk.php?*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kwk"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "/"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "kwk"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2/15/2022, 16:06:45

